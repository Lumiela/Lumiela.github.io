-- 1. 기존에 설정했던 삭제 정책이 있다면 먼저 제거합니다.
DROP POLICY IF EXISTS "자신의 글만 삭제 가능" ON notices;
DROP POLICY IF EXISTS "로그인한 사용자 전체 삭제 허용" ON notices;

-- 2. 로그인한 사용자(authenticated)라면 모든 행(row)을 삭제할 수 있도록 새 정책 생성
CREATE POLICY "로그인한 사용자 전체 삭제 허용"
ON notices FOR DELETE
TO authenticated
USING (true); -- 조건 없이(true) 인증된 사용자라면 모두 허용

-- notices 테이블 생성
CREATE TABLE notices (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at timestamptz DEFAULT now(),
  title text NOT NULL,
  content text,
  author text,
  -- 자동 증가하는 순차 번호 (identity 컬럼)
  notice_no bigint GENERATED BY DEFAULT AS IDENTITY
);

-- RLS(보안 정책) 활성화
ALTER TABLE notices ENABLE ROW LEVEL SECURITY;

-- 기존 정책 삭제 (중복 방지)
DROP POLICY IF EXISTS "누구나 읽기 가능" ON notices;

-- 정책 생성
CREATE POLICY "누구나 읽기 가능" 
ON notices FOR SELECT 
USING (true);

-- 기존 정책 삭제
DROP POLICY IF EXISTS "인증된 사용자만 글쓰기 가능" ON notices;

-- 정책 생성
CREATE POLICY "인증된 사용자만 글쓰기 가능" 
ON notices FOR INSERT 
TO authenticated 
WITH CHECK (true);

-- 기존 정책 삭제
DROP POLICY IF EXISTS "자신의 글만 삭제 가능" ON notices;
DROP POLICY IF EXISTS "로그인한 사용자 전체 삭제 허용" ON notices;

-- 정책 생성
CREATE POLICY "로그인한 사용자 전체 삭제 허용"
ON notices FOR DELETE
TO authenticated
USING (true);

-- 1. 기존에 혹시 있을지 모르는 수정 정책을 삭제합니다.
DROP POLICY IF EXISTS "로그인한 사용자 전체 수정 허용" ON notices;

-- 2. 로그인한 사용자(authenticated)에게 모든 행의 수정을 허용합니다.
CREATE POLICY "로그인한 사용자 전체 수정 허용"
ON notices FOR UPDATE
TO authenticated
USING (true)
WITH CHECK (true);

-- 1. 자료실 전용 테이블 생성 (컬럼 누락 에러 방지)
CREATE TABLE IF NOT EXISTS archives (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at timestamptz DEFAULT now(),
  title text NOT NULL,
  content text,
  author text DEFAULT '관리자',
  file_url text,      -- 실제 파일 주소
  file_name text,     -- 사용자가 볼 한글 이름
  notice_no bigint GENERATED BY DEFAULT AS IDENTITY
);

-- 2. RLS 보안 설정
ALTER TABLE archives ENABLE ROW LEVEL SECURITY;
CREATE POLICY "누구나 조회 가능" ON archives FOR SELECT USING (true);
CREATE POLICY "관리자만 수정 가능" ON archives FOR ALL TO authenticated USING (true);

-- (1) 조회 권한: 누구나 자료를 볼 수 있음
CREATE POLICY "자료실 누구나 읽기 가능" 
ON archives FOR SELECT 
USING (true);

-- (2) 삽입 권한: 로그인한 사용자만 자료 업로드 가능
CREATE POLICY "자료실 로그인 사용자 업로드 허용" 
ON archives FOR INSERT 
TO authenticated 
WITH CHECK (true);

-- (3) 수정 권한: 로그인한 사용자만 자료 수정 가능
CREATE POLICY "자료실 로그인 사용자 수정 허용" 
ON archives FOR UPDATE 
TO authenticated 
USING (true)
WITH CHECK (true);

-- (4) 삭제 권한: 로그인한 사용자만 자료 삭제 가능
CREATE POLICY "자료실 로그인 사용자 삭제 허용" 
ON archives FOR DELETE 
TO authenticated 
USING (true);

-- (1) 파일 업로드 권한: 로그인한 사용자만 daonrs 버킷에 업로드 가능
CREATE POLICY "스토리지 업로드 허용"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'daonrs');

-- (2) 파일 조회 권한: 누구나 업로드된 파일을 다운로드/조회 가능
CREATE POLICY "스토리지 파일 조회 허용"
ON storage.objects FOR SELECT
USING (bucket_id = 'daonrs');

-- (3) 파일 삭제 권한: 관리자가 파일을 지울 수 있게 허용
CREATE POLICY "스토리지 파일 삭제 허용"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'daonrs');

create table history (
  id uuid default gen_random_uuid() primary key,
  year text not null,
  events jsonb not null, -- JSON 형식을 그대로 담습니다.
  order_index int unique, -- 출력 순서 (숫자가 클수록 최신)
  created_at timestamp with time zone default now()
);

-- 초기 데이터 삽입 (제공해주신 JSON 내용)
insert into history (year, events, order_index)
values 
('2025', '[{"month": "01.14", "content": "400농가 200만주 이상 보급 (병해충 발생 0%)"}, {"month": "05.22", "content": "스마트 육묘 시스템 판매 시작"}, {"month": "08.01", "content": "스마트 육묘 시스템 일본 진출"}]', 2),
('2024', '[{"month": "03", "content": "2호 스마트 육묘 시스템 구축"}, {"month": "06", "content": "농업회사법인 한국표준육묘 설립"}]', 1);

-- 1. 기존 테이블 삭제
DROP TABLE IF EXISTS public.inquiries;

-- 2. 테이블 생성 (새 필드 추가: company, phone, subject)
CREATE TABLE public.inquiries (
  id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name character varying(100) NOT NULL,
  email character varying(255) NOT NULL,
  company character varying(255) NOT NULL, -- 추가
  phone character varying(50) NOT NULL,   -- 추가
  subject character varying(255) NOT NULL, -- 추가
  message text NOT NULL,
  is_read boolean DEFAULT false,
  
  CONSTRAINT inquiries_pkey PRIMARY KEY (id),
  CONSTRAINT message_min_length CHECK (char_length(message) >= 5)
);

-- 3. RLS 활성화
ALTER TABLE public.inquiries ENABLE ROW LEVEL SECURITY;

-- 4. 정책: 누구나 문의를 남길 수 있음 (Insert)
CREATE POLICY "Enable insert for anon users"
ON public.inquiries FOR INSERT TO anon 
WITH CHECK (true);

-- 5. 정책: 관리자만 문의를 읽을 수 있음 (Select)
CREATE POLICY "Enable read for authenticated users"
ON public.inquiries FOR SELECT TO authenticated 
USING (true);

-- 6. 정책: 관리자만 업데이트 가능
CREATE POLICY "Enable update for authenticated users"
ON public.inquiries FOR UPDATE TO authenticated 
USING (true)
WITH CHECK (true);

create table case_examples (
  id uuid default gen_random_uuid() primary key,
  title text not null,
  content text, -- HTML (ReactQuill 내용)
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create table intellectual_properties (
  id uuid default uuid_generate_v4() primary key,
  title text not null,
  image_url text not null,
  storage_path text not null,
  display_order int default 0,
  created_at timestamp with time zone default now()
);

ALTER TABLE case_examples 
ADD COLUMN region TEXT,
ADD COLUMN crop TEXT,
ADD COLUMN facility_type TEXT,
ADD COLUMN area TEXT;